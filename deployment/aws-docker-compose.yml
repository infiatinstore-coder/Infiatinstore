version: '3.8'

services:
  # ==============================================
  # WAHA - WhatsApp HTTP API
  # ==============================================
  waha:
    image: devlikeapro/waha:latest
    container_name: infiatin-waha
    restart: always
    ports:
      - "3123:3000"
    environment:
      # Print QR code in logs for easy scanning
      - WAHA_PRINT_QR=True
      
      # Logging level (debug, info, warn, error)
      - WAHA_LOG_LEVEL=info
      
      # Session management
      - WAHA_SESSIONS_ENABLED=true
      
      # API Security (uncomment untuk production)
      # - WAHA_API_KEY=infiatin-store-2025DEC-9K7XQ2M8L4A6
      
      # Timezone
      - TZ=Asia/Jakarta
      
    volumes:
      # Persistent session data
      - ./data/waha-auth:/app/.wwebjs_auth
      - ./data/waha-cache:/app/.wwebjs_cache
      
    networks:
      - infiatin-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/sessions"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================
  # n8n - Workflow Automation
  # ==============================================
  n8n:
    image: n8nio/n8n:latest
    container_name: infiatin-n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      # Basic Authentication (CHANGE IN PRODUCTION!)
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=ChangeThisStrongPassword123!
      
      # Network Configuration
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      
      # Webhook URL (CHANGE to your EC2 IP or domain!)
      - WEBHOOK_URL=http://YOUR_EC2_IP:5678/
      - N8N_EDITOR_BASE_URL=http://YOUR_EC2_IP:5678/
      
      # Timezone
      - GENERIC_TIMEZONE=Asia/Jakarta
      - TZ=Asia/Jakarta
      
      # Execution settings
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_MODE=regular
      
      # Security
      - N8N_METRICS=false
      - N8N_DIAGNOSTICS_ENABLED=false
      
    volumes:
      # Persistent workflow data
      - ./data/n8n:/home/node/.n8n
      
    networks:
      - infiatin-network
    
    depends_on:
      - waha
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

# ==============================================
# Docker Networks
# ==============================================
networks:
  infiatin-network:
    driver: bridge

# ==============================================
# NOTES:
# ==============================================
# 1. Replace YOUR_EC2_IP with actual EC2 public IP
# 2. Change N8N_BASIC_AUTH_PASSWORD before deployment
# 3. For production, setup SSL with nginx reverse proxy
# 4. Data persisted in ./data/ directory
# 5. Access:
#    - WAHA: http://YOUR_EC2_IP:3123
#    - n8n: http://YOUR_EC2_IP:5678
